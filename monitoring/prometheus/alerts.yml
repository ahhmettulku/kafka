groups:
  # ---------------------------------------------------------------------------
  # Kafka Broker Alerts (from kafka-exporter)
  # ---------------------------------------------------------------------------
  - name: kafka_broker_alerts
    interval: 30s
    rules:
      - alert: KafkaBrokersDown
        expr: kafka_brokers < 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No Kafka brokers available"
          description: "Kafka cluster has {{ $value }} brokers. Expected at least 1."
          runbook_url: "https://wiki.company.com/runbooks/kafka-brokers-down"

      - alert: KafkaTopicPartitionUnderReplicated
        expr: kafka_topic_partition_under_replicated_partition > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka partition under-replicated"
          description: "Topic {{ $labels.topic }} partition {{ $labels.partition }} is under-replicated."
          runbook_url: "https://wiki.company.com/runbooks/kafka-under-replicated"

      - alert: KafkaPartitionNoLeader
        expr: kafka_topic_partition_leader == -1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka partition has no leader"
          description: "Topic {{ $labels.topic }} partition {{ $labels.partition }} has no leader. Writes will fail."
          runbook_url: "https://wiki.company.com/runbooks/kafka-no-leader"

      - alert: KafkaConsumerGroupLagHigh
        expr: kafka_consumergroup_lag > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High consumer group lag (broker view)"
          description: "Consumer group {{ $labels.consumergroup }} has lag of {{ $value }} on topic {{ $labels.topic }}."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumergroup-lag"

      - alert: KafkaConsumerGroupLagCritical
        expr: kafka_consumergroup_lag > 100000
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical consumer group lag (broker view)"
          description: "Consumer group {{ $labels.consumergroup }} has lag of {{ $value }} on topic {{ $labels.topic }}. Immediate attention required."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumergroup-lag-critical"

      - alert: KafkaNoActiveConsumers
        expr: kafka_consumergroup_members == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No active consumers in group"
          description: "Consumer group {{ $labels.consumergroup }} has no active members."
          runbook_url: "https://wiki.company.com/runbooks/kafka-no-consumers"

  # ---------------------------------------------------------------------------
  # Kafka JMX Broker Alerts (from jmx-exporter)
  # ---------------------------------------------------------------------------
  - name: kafka_jmx_alerts
    interval: 30s
    rules:
      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_server_replicamanager_underreplicatedpartitions > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka has under-replicated partitions"
          description: "Kafka broker has {{ $value }} under-replicated partitions. Data durability may be at risk."
          runbook_url: "https://wiki.company.com/runbooks/kafka-under-replicated-jmx"

      - alert: KafkaOfflinePartitions
        expr: kafka_controller_kafkacontroller_offlinepartitionscount > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka has offline partitions"
          description: "Kafka controller reports {{ $value }} offline partitions. These partitions are unavailable for reads/writes."
          runbook_url: "https://wiki.company.com/runbooks/kafka-offline-partitions"

      - alert: KafkaNoActiveController
        expr: kafka_controller_kafkacontroller_activecontrollercount == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "No active Kafka controller"
          description: "No Kafka controller is active. Cluster cannot perform leader elections or partition reassignments."
          runbook_url: "https://wiki.company.com/runbooks/kafka-no-controller"

      - alert: KafkaISRShrinking
        expr: rate(kafka_server_replicamanager_isrshrinkspersec_total[5m]) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafka ISR is shrinking"
          description: "In-sync replica set is shrinking at {{ $value }} partitions/sec. Possible broker issues or network problems."
          runbook_url: "https://wiki.company.com/runbooks/kafka-isr-shrinking"

      - alert: KafkaISRShrinkingRapidly
        expr: rate(kafka_server_replicamanager_isrshrinkspersec_total[5m]) > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka ISR is shrinking rapidly"
          description: "In-sync replica set is shrinking rapidly at {{ $value }} partitions/sec. Immediate investigation required."
          runbook_url: "https://wiki.company.com/runbooks/kafka-isr-shrinking-critical"

      - alert: KafkaHighProduceLatency
        expr: kafka_network_requestmetrics_totaltime_ms_p99{request="Produce"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Kafka produce request latency"
          description: "P99 produce request latency is {{ $value }}ms. Producer performance may be degraded."
          runbook_url: "https://wiki.company.com/runbooks/kafka-produce-latency"

      - alert: KafkaCriticalProduceLatency
        expr: kafka_network_requestmetrics_totaltime_ms_p99{request="Produce"} > 5000
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical Kafka produce request latency"
          description: "P99 produce request latency is {{ $value }}ms. Producers are severely impacted."
          runbook_url: "https://wiki.company.com/runbooks/kafka-produce-latency-critical"

      - alert: KafkaHighFetchLatency
        expr: kafka_network_requestmetrics_totaltime_ms_p99{request=~"Fetch|FetchConsumer"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Kafka fetch request latency"
          description: "P99 {{ $labels.request }} latency is {{ $value }}ms. Consumer performance may be degraded."
          runbook_url: "https://wiki.company.com/runbooks/kafka-fetch-latency"

      - alert: KafkaNetworkProcessorIdleLow
        expr: kafka_network_socketserver_networkprocessor_avg_idle_percent < 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka network processor utilization high"
          description: "Network processor idle percentage is {{ $value | humanizePercentage }}. Broker may be overloaded."
          runbook_url: "https://wiki.company.com/runbooks/kafka-network-processor"

      - alert: KafkaRequestHandlerIdleLow
        expr: kafka_server_kafkarequesthandlerpool_avg_idle_percent < 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka request handler utilization high"
          description: "Request handler idle percentage is {{ $value | humanizePercentage }}. Broker may be overloaded."
          runbook_url: "https://wiki.company.com/runbooks/kafka-request-handler"

      - alert: KafkaLogFlushLatencyHigh
        expr: kafka_log_logflushstats_logflush_time_ms_p99 > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Kafka log flush latency"
          description: "P99 log flush latency is {{ $value }}ms. Disk I/O may be a bottleneck."
          runbook_url: "https://wiki.company.com/runbooks/kafka-log-flush-latency"

      - alert: KafkaOfflineLogDirectory
        expr: kafka_log_logmanager_offline_log_directory_count > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka log directory offline"
          description: "{{ $value }} log directories are offline. Data may be inaccessible."
          runbook_url: "https://wiki.company.com/runbooks/kafka-offline-log-directory"

      - alert: KafkaBrokerHighHeapUsage
        expr: kafka_jvm_heap_memory_used_bytes / kafka_jvm_heap_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka broker high heap memory usage"
          description: "Kafka broker heap usage is {{ $value | humanizePercentage }}. Risk of GC pressure or OOM."
          runbook_url: "https://wiki.company.com/runbooks/kafka-heap-usage"

      - alert: KafkaBrokerCriticalHeapUsage
        expr: kafka_jvm_heap_memory_used_bytes / kafka_jvm_heap_memory_max_bytes > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka broker critical heap memory usage"
          description: "Kafka broker heap usage is {{ $value | humanizePercentage }}. OOM imminent."
          runbook_url: "https://wiki.company.com/runbooks/kafka-heap-usage-critical"

      - alert: KafkaBrokerHighCPU
        expr: kafka_jvm_process_cpu_load > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka broker high CPU usage"
          description: "Kafka broker CPU usage is {{ $value | humanizePercentage }}."
          runbook_url: "https://wiki.company.com/runbooks/kafka-cpu-usage"

      - alert: KafkaPreferredReplicaImbalance
        expr: kafka_controller_kafkacontroller_preferredreplicaimbalancecount > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Kafka preferred replica imbalance"
          description: "{{ $value }} partitions have non-preferred leaders. Consider running preferred replica election."
          runbook_url: "https://wiki.company.com/runbooks/kafka-replica-imbalance"

  # ---------------------------------------------------------------------------
  # Kafka Application Alerts (from app metrics)
  # ---------------------------------------------------------------------------
  - name: kafka_alerts
    interval: 30s
    rules:
      # Alert when producer is disconnected
      - alert: KafkaProducerDisconnected
        expr: kafka_producer_connection_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka producer is disconnected"
          description: "Kafka producer connection is down. Messages cannot be sent to Kafka."
          runbook_url: "https://wiki.company.com/runbooks/kafka-producer-disconnected"

      # Alert when consumer is disconnected
      - alert: KafkaConsumerDisconnected
        expr: kafka_consumer_connection_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer is disconnected"
          description: "Kafka consumer connection is down. Messages are not being consumed."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-disconnected"

      # Alert when lag is growing - indicates consumer can't keep up with producer
      - alert: KafkaConsumerLagGrowing
        expr: deriv(kafka_consumer_lag[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag is growing"
          description: "Consumer lag is increasing at {{ $value | printf \"%.1f\" }} messages/sec for topic {{ $labels.topic }}, partition {{ $labels.partition }}. Consumer cannot keep up with producer."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-lag-growing"

      # Alert when lag is growing rapidly - consumer is falling behind fast
      - alert: KafkaConsumerLagGrowingFast
        expr: deriv(kafka_consumer_lag[5m]) > 100
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer lag is growing rapidly"
          description: "Consumer lag is increasing at {{ $value | printf \"%.1f\" }} messages/sec for topic {{ $labels.topic }}, partition {{ $labels.partition }}. Immediate attention required."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-lag-growing-critical"

      # Alert based on time-to-drain: how long to catch up at current consumption rate
      - alert: KafkaHighTimeToDrain
        expr: |
          (
            kafka_consumer_lag
            /
            (rate(kafka_consumer_messages_consumed_total{status="success"}[5m]) > 0)
          ) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Kafka consumer time-to-drain"
          description: "At current consumption rate, it will take {{ $value | humanizeDuration }} to drain the backlog for topic {{ $labels.topic }}, partition {{ $labels.partition }}."
          runbook_url: "https://wiki.company.com/runbooks/kafka-time-to-drain"

      # Critical: would take more than 30 minutes to catch up
      - alert: KafkaCriticalTimeToDrain
        expr: |
          (
            kafka_consumer_lag
            /
            (rate(kafka_consumer_messages_consumed_total{status="success"}[5m]) > 0)
          ) > 1800
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical Kafka consumer time-to-drain"
          description: "At current consumption rate, it will take {{ $value | humanizeDuration }} to drain the backlog for topic {{ $labels.topic }}, partition {{ $labels.partition }}. SLA breach imminent."
          runbook_url: "https://wiki.company.com/runbooks/kafka-time-to-drain-critical"

      # Alert when consumption rate drops significantly (consumer slowdown)
      - alert: KafkaConsumerThroughputDrop
        expr: |
          (
            rate(kafka_consumer_messages_consumed_total{status="success"}[5m])
            /
            rate(kafka_consumer_messages_consumed_total{status="success"}[1h] offset 5m)
          ) < 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer throughput dropped"
          description: "Consumer throughput dropped to {{ $value | humanizePercentage }} of its hourly average for topic {{ $labels.topic }}. Possible consumer degradation."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-throughput-drop"

      - alert: KafkaProducerErrors
        expr: rate(kafka_producer_messages_sent_total{status="error"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka producer errors detected"
          description: "Producer error rate is {{ $value }} per second on topic {{ $labels.topic }}"
          runbook_url: "https://wiki.company.com/runbooks/kafka-producer-errors"

      - alert: KafkaConsumerErrors
        expr: rate(kafka_consumer_messages_consumed_total{status="error"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer errors detected"
          description: "Consumer error rate is {{ $value }} per second on topic {{ $labels.topic }}"
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-errors"

      - alert: KafkaHighConsumerLagSeconds
        expr: kafka_consumer_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer time lag is high"
          description: "Consumer is {{ $value }}s behind for topic {{ $labels.topic }}, partition {{ $labels.partition }}. Messages are delayed."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-lag-seconds"

      - alert: KafkaCriticalConsumerLagSeconds
        expr: kafka_consumer_lag_seconds > 300
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafka consumer time lag is critical"
          description: "Consumer is {{ $value }}s ({{ $value | humanizeDuration }}) behind for topic {{ $labels.topic }}, partition {{ $labels.partition }}. SLA breach likely."
          runbook_url: "https://wiki.company.com/runbooks/kafka-consumer-lag-seconds-critical"

  - name: redis_alerts
    interval: 30s
    rules:
      - alert: RedisConnectionDown
        expr: redis_connection_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis connection is down"
          description: "Redis {{ $labels.client_type }} connection is unavailable"
          runbook_url: "https://wiki.company.com/runbooks/redis-connection-down"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is at {{ $value | humanizePercentage }}. Risk of evictions or OOM."
          runbook_url: "https://wiki.company.com/runbooks/redis-memory-high"

      - alert: RedisMemoryCritical
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis memory critically high"
          description: "Redis memory usage is at {{ $value | humanizePercentage }}. Immediate action required to prevent data loss."
          runbook_url: "https://wiki.company.com/runbooks/redis-memory-critical"

      - alert: RedisConnectionPoolExhaustion
        expr: redis_connection_pool_available / redis_connection_pool_size < 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis connection pool nearly exhausted"
          description: "Only {{ $value | humanizePercentage }} of Redis connections available. Application may experience connection timeouts."
          runbook_url: "https://wiki.company.com/runbooks/redis-pool-exhaustion"

      - alert: RedisConnectionPoolLow
        expr: redis_connection_pool_available / redis_connection_pool_size < 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis connection pool running low"
          description: "Only {{ $value | humanizePercentage }} of Redis connections available. Consider scaling or investigating connection leaks."
          runbook_url: "https://wiki.company.com/runbooks/redis-pool-low"

      - alert: RedisSlowOperations
        expr: histogram_quantile(0.95, rate(redis_operation_duration_seconds_bucket[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis operations are slow"
          description: "95th percentile latency is {{ $value }}s for operation {{ $labels.operation }}"
          runbook_url: "https://wiki.company.com/runbooks/redis-slow-operations"

      - alert: RedisSlowOperationsCritical
        expr: histogram_quantile(0.95, rate(redis_operation_duration_seconds_bucket[5m])) > 0.5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis operations critically slow"
          description: "95th percentile latency is {{ $value }}s for operation {{ $labels.operation }}. Application performance severely impacted."
          runbook_url: "https://wiki.company.com/runbooks/redis-slow-operations-critical"

      - alert: RedisOperationErrors
        expr: rate(redis_operations_total{status="error"}[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis operation errors detected"
          description: "Error rate is {{ $value }} per second for operation {{ $labels.operation }}. May cascade to application failures."
          runbook_url: "https://wiki.company.com/runbooks/redis-operation-errors"

      - alert: RedisEvictions
        expr: rate(redis_evicted_keys_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis is evicting keys"
          description: "Redis is evicting {{ $value }} keys per second due to memory pressure. Data loss may be occurring."
          runbook_url: "https://wiki.company.com/runbooks/redis-evictions"

  - name: http_alerts
    interval: 30s
    rules:
      - alert: HighHTTPErrorRate
        expr: |
          (
            rate(http_requests_total{status_code=~"5.."}[5m])
            /
            rate(http_requests_total[5m])
          ) > 0.01
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High HTTP error rate"
          description: "5xx error rate is {{ $value | humanizePercentage }} on {{ $labels.route }}"
          runbook_url: "https://wiki.company.com/runbooks/http-error-rate"

      - alert: HTTPErrorRateWarning
        expr: |
          (
            rate(http_requests_total{status_code=~"5.."}[5m])
            /
            rate(http_requests_total[5m])
          ) > 0.005
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Elevated HTTP error rate"
          description: "5xx error rate is {{ $value | humanizePercentage }} on {{ $labels.route }}"
          runbook_url: "https://wiki.company.com/runbooks/http-error-rate-warning"

      - alert: SlowHTTPResponses
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow HTTP responses detected"
          description: "95th percentile response time is {{ $value }}s on {{ $labels.route }}"
          runbook_url: "https://wiki.company.com/runbooks/http-slow-responses"

      - alert: SlowHTTPResponsesCritical
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTP responses critically slow"
          description: "95th percentile response time is {{ $value }}s on {{ $labels.route }}. Users are severely impacted."
          runbook_url: "https://wiki.company.com/runbooks/http-slow-responses-critical"

      - alert: HighHTTPRequestLatencyP99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High P99 HTTP latency"
          description: "99th percentile response time is {{ $value }}s on {{ $labels.route }}. Tail latency affecting some users."
          runbook_url: "https://wiki.company.com/runbooks/http-p99-latency"

  - name: sse_alerts
    interval: 30s
    rules:
      - alert: SSEConnectionDrops
        expr: rate(sse_connections_total{status="disconnected", reason!~"client_closed|timeout"}[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High SSE connection drop rate"
          description: "SSE connections are dropping unexpectedly at {{ $value }} per second (excluding client-initiated closes)"
          runbook_url: "https://wiki.company.com/runbooks/sse-connection-drops"

      - alert: SSEErrors
        expr: rate(sse_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "SSE errors detected"
          description: "SSE error rate is {{ $value }} per second for error type {{ $labels.error_type }}"
          runbook_url: "https://wiki.company.com/runbooks/sse-errors"

      - alert: SSEHighActiveConnections
        expr: sse_active_connections > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of SSE connections"
          description: "{{ $value }} active SSE connections. Monitor server resources."
          runbook_url: "https://wiki.company.com/runbooks/sse-high-connections"

  - name: application_alerts
    interval: 30s
    rules:
      - alert: HighMessageProcessingLatency
        expr: histogram_quantile(0.95, rate(kafka_consumer_message_processing_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High message processing latency"
          description: "95th percentile message processing time is {{ $value }}s. End-to-end latency is elevated."
          runbook_url: "https://wiki.company.com/runbooks/message-processing-latency"

      - alert: MessageProcessingLatencyCritical
        expr: histogram_quantile(0.95, rate(kafka_consumer_message_processing_duration_seconds_bucket[5m])) > 15
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical message processing latency"
          description: "95th percentile message processing time is {{ $value }}s. System is severely backlogged."
          runbook_url: "https://wiki.company.com/runbooks/message-processing-latency-critical"

      - alert: MessageProcessingFailures
        expr: |
          (
            rate(kafka_consumer_messages_consumed_total{status="error"}[5m])
            /
            rate(kafka_consumer_messages_consumed_total[5m])
          ) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Message processing failures detected"
          description: "{{ $value | humanizePercentage }} of messages are failing to process."
          runbook_url: "https://wiki.company.com/runbooks/message-processing-failures"

      - alert: NoMessagesProcessed
        expr: rate(kafka_consumer_messages_consumed_total[10m]) == 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No messages being processed"
          description: "No messages have been processed in the last 10 minutes. Check if consumers are running."
          runbook_url: "https://wiki.company.com/runbooks/no-messages-processed"
